name: Deploy Auth System

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'éƒ¨ç½²åŸå› '
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘éƒ¨ç½²'
      domain:
        description: 'éƒ¨ç½²åŸŸå'
        required: false
        default: 'tinotools.cn'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®PHPç¯å¢ƒ
      uses: shivammathur/setup-php@v2
      with:
        php-version: '7.2'
        extensions: mbstring, dom, fileinfo, curl, sqlite3, pdo_sqlite
        tools: composer:v2
    
    - name: å®‰è£…ä¾èµ–
      run: |
        composer install --no-dev --optimize-autoloader
    
    - name: ä»£ç æ£€æŸ¥
      run: |
        php -l public/index.php || true
        find admin -type f -name "*.php" -exec php -l {} \; || true
        echo "PHPè¯­æ³•æ£€æŸ¥å®Œæˆ"
    
    - name: å®‰è£…éƒ¨ç½²å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y dos2unix

    - name: è®¾ç½®SSHå¯†é’¥
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
        config: |
          Host server
            HostName ${{ secrets.SERVER_IP }}
            Port ${{ secrets.SERVER_PORT }}
            User ${{ secrets.SERVER_USER }}
            IdentityFile ~/.ssh/id_rsa
    
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      env:
        DOMAIN: ${{ github.event.inputs.domain || 'tinotools.cn' }}
      run: |
        # å¤‡ä»½å½“å‰æ–‡ä»¶
        ssh server "mkdir -p /var/www/backups/$(date +%Y%m%d)"
        ssh server "cp -r /www/wwwroot/tinotools/auth/public_html /var/www/backups/$(date +%Y%m%d)/auth || true"
        ssh server "cp -r /www/wwwroot/tinotools/admin/public_html /var/www/backups/$(date +%Y%m%d)/admin || true"
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        ssh server "mkdir -p /www/wwwroot/tinotools/auth/public_html"
        ssh server "mkdir -p /www/wwwroot/tinotools/admin/public_html"
        ssh server "mkdir -p /www/wwwroot/tinotools/config"
        ssh server "mkdir -p /var/log/auth"
        
        # è½¬æ¢æ‰€æœ‰çš„æ¢è¡Œç¬¦ä¸ºUnixæ ¼å¼
        find . -type f -name "*.php" -exec dos2unix {} \; || true
        find . -type f -name "*.sh" -exec dos2unix {} \; || true
        
        # éƒ¨ç½²è®¤è¯ç³»ç»Ÿæ–‡ä»¶
        scp -r public/* server:/www/wwwroot/tinotools/auth/public_html/ || echo "æ²¡æœ‰publicæ–‡ä»¶å¤¹ï¼Œè·³è¿‡"
        
        # éƒ¨ç½²ç®¡ç†åå°æ–‡ä»¶
        if [ -d "admin" ]; then
          scp -r admin/* server:/www/wwwroot/tinotools/admin/public_html/
        else
          echo "æ²¡æœ‰adminæ–‡ä»¶å¤¹ï¼Œè·³è¿‡"
        fi
        
        # éƒ¨ç½²é…ç½®æ–‡ä»¶
        if [ -d "config" ]; then
          scp -r config/* server:/www/wwwroot/tinotools/config/
        else
          echo "æ²¡æœ‰configæ–‡ä»¶å¤¹ï¼Œè·³è¿‡"
        fi
        
        # éƒ¨ç½².envæ–‡ä»¶
        if [ -f ".env.example" ]; then
          scp -r .env.example server:/www/wwwroot/tinotools/.env.example
        else
          echo "æ²¡æœ‰.env.exampleæ–‡ä»¶ï¼Œè·³è¿‡"
        fi
        
        # éƒ¨ç½²Nginxé…ç½®æ–‡ä»¶
        # å…ˆåˆ é™¤å¯èƒ½å†²çªçš„é…ç½®æ–‡ä»¶
        ssh server "sudo mkdir -p /etc/nginx/conf.d.bak/$(date +%Y%m%d)"
        ssh server "sudo mv /etc/nginx/conf.d/auth.conf /etc/nginx/conf.d.bak/$(date +%Y%m%d)/auth.conf.bak || true"
        ssh server "sudo mv /etc/nginx/conf.d/n8n.conf /etc/nginx/conf.d.bak/$(date +%Y%m%d)/n8n.conf.bak || true"
        ssh server "sudo mv /etc/nginx/conf.d/ssl.conf /etc/nginx/conf.d.bak/$(date +%Y%m%d)/ssl.conf.bak || true"
        ssh server "sudo cp /etc/nginx/conf.d/*.conf /etc/nginx/conf.d.bak/$(date +%Y%m%d)/ || true"
        
        # ä¸Šä¼ æ–°çš„é…ç½®æ–‡ä»¶
        scp nginx/*.tinotools.cn.conf server:/tmp/
        ssh server "sudo mv /tmp/*.conf /etc/nginx/conf.d/"
        ssh server "sudo nginx -t && sudo systemctl reload nginx || (echo 'âŒ Nginxé…ç½®æµ‹è¯•å¤±è´¥' && exit 1)"
        
        # éƒ¨ç½²è„šæœ¬æ–‡ä»¶
        if [ -d "scripts" ]; then
          scp -r scripts server:/www/wwwroot/tinotools/
          ssh server "chmod +x /www/wwwroot/tinotools/scripts/*.sh || true"
        else
          echo "æ²¡æœ‰scriptsæ–‡ä»¶å¤¹ï¼Œè·³è¿‡"
        fi
        
        # æ›¿æ¢åŸŸåï¼ˆå¦‚æœä¸æ˜¯é»˜è®¤çš„tinotools.cnï¼‰
        if [[ "$DOMAIN" != "tinotools.cn" ]]; then
          echo "è‡ªå®šä¹‰åŸŸå: $DOMAINï¼Œæ›´æ–°é…ç½®ä¸­..."
          
          # æ›´æ–°ç¯å¢ƒæ–‡ä»¶
          ssh server "sed -i 's/tinotools.cn/$DOMAIN/g' /www/wwwroot/tinotools/.env.example"
          ssh server "cp /www/wwwroot/tinotools/.env.example /www/wwwroot/tinotools/.env"
          
          # æ›´æ–°é…ç½®æ–‡ä»¶
          ssh server "sed -i 's/tinotools.cn/$DOMAIN/g' /www/wwwroot/tinotools/config/config.php || true"
          
          # æ›´æ–°Nginxé…ç½®
          ssh server "for file in /etc/nginx/conf.d/*.conf; do sed -i 's/tinotools.cn/$DOMAIN/g' \$file; done"
          ssh server "sudo nginx -t && sudo systemctl reload nginx || (echo 'âŒ Nginxé…ç½®æµ‹è¯•å¤±è´¥' && exit 1)"
        fi
        
        # è®¾ç½®æ–‡ä»¶æƒé™
        ssh server "find /www/wwwroot/tinotools -type f -exec chmod 644 {} \;"
        ssh server "find /www/wwwroot/tinotools -type d -exec chmod 755 {} \;"
        ssh server "find /www/wwwroot/tinotools/scripts -type f -name '*.sh' -exec chmod +x {} \; || true"
        ssh server "chown -R nginx:nginx /www/wwwroot/tinotools"
        
        # éªŒè¯éƒ¨ç½²
        echo "éªŒè¯éƒ¨ç½²çŠ¶æ€..."
        SSH_DOMAIN=${DOMAIN:-tinotools.cn}
        
        # æ£€æŸ¥authæœåŠ¡
        echo "auth.${SSH_DOMAIN} éƒ¨ç½²çŠ¶æ€:"
        DEPLOY_CHECK=$(ssh server "ls -la /www/wwwroot/tinotools/auth/public_html/index.php || echo 'æ–‡ä»¶ä¸å­˜åœ¨'")
        echo "$DEPLOY_CHECK"
        
        # æ£€æŸ¥adminæœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        echo "admin.${SSH_DOMAIN} éƒ¨ç½²çŠ¶æ€:"
        ADMIN_CHECK=$(ssh server "ls -la /www/wwwroot/tinotools/admin/public_html/index.php || echo 'æ–‡ä»¶ä¸å­˜åœ¨'")
        echo "$ADMIN_CHECK"
        
        echo "ğŸ‰ éƒ¨ç½²è¿‡ç¨‹å®Œæˆ!"
    
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      if: always()
      env:
        DOMAIN: ${{ github.event.inputs.domain || 'tinotools.cn' }}
      run: |
        STATUS="${{ job.status }}"
        if [ "$STATUS" = "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼šæ‰€æœ‰ç³»ç»Ÿå·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
          echo "- auth.${DOMAIN} - è®¤è¯ç³»ç»Ÿ"
          echo "- admin.${DOMAIN} - ç®¡ç†åå°"
          echo "- n8n.${DOMAIN} - å·¥ä½œæµè‡ªåŠ¨åŒ–"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šè¯·æ£€æŸ¥æ—¥å¿—ç¡®å®šåŸå› "
        fi 
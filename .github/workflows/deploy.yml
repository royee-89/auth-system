name: Deploy Auth System

on:
  push:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      reason:
        description: 'éƒ¨ç½²åŸå› '
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘éƒ¨ç½²'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: è®¾ç½®PHPç¯å¢ƒ
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, dom, fileinfo, curl
    
    - name: å®‰è£…ä¾èµ–
      run: |
        echo "æ— éœ€å®‰è£…PHPä¾èµ–"
    
    - name: ä»£ç æ£€æŸ¥
      run: |
        php -l public/index.php
        echo "PHPè¯­æ³•æ£€æŸ¥é€šè¿‡"
    
    - name: è®¾ç½®SSHå¯†é’¥
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
        config: |
          Host server
            HostName ${{ secrets.SERVER_IP }}
            User ${{ secrets.SERVER_USER }}
            IdentityFile ~/.ssh/id_rsa
    
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      run: |
        # å¤‡ä»½å½“å‰æ–‡ä»¶
        ssh server "cp /var/www/auth.royeenote.online/public_html/index.php /var/www/auth.royeenote.online/public_html/index.php.bak-$(date +%Y%m%d%H%M%S) || true"
        
        # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        ssh server "mkdir -p /var/www/auth.royeenote.online/public_html"
        
        # è½¬æ¢æ‰€æœ‰çš„æ¢è¡Œç¬¦ä¸ºUnixæ ¼å¼ï¼Œé¿å…Windows/Macæ¢è¡Œç¬¦é—®é¢˜
        find public -type f -name "*.php" -exec dos2unix {} \;
        
        # éƒ¨ç½²æ–‡ä»¶
        scp -r public/* server:/var/www/auth.royeenote.online/public_html/
        
        # è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
        ssh server "find /var/www/auth.royeenote.online/public_html -type f -exec chmod 644 {} \;"
        ssh server "find /var/www/auth.royeenote.online/public_html -type d -exec chmod 755 {} \;"
        ssh server "chown -R www-data:www-data /var/www/auth.royeenote.online/public_html"
        
        # éªŒè¯éƒ¨ç½²
        echo "éªŒè¯éƒ¨ç½²çŠ¶æ€..."
        DEPLOY_CHECK=$(ssh server "ls -la /var/www/auth.royeenote.online/public_html/index.php")
        echo "$DEPLOY_CHECK"
        
        if [[ -n "$DEPLOY_CHECK" ]]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸ!"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥!"
          exit 1
        fi
    
    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      if: always()
      run: |
        STATUS="${{ job.status }}"
        if [ "$STATUS" = "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼šauth-systemå·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼šè¯·æ£€æŸ¥æ—¥å¿—ç¡®å®šåŸå› "
        fi 